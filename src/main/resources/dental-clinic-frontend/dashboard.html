<!DOCTYPE html>
<html lang="es">
<head>
    <title>Dashboard - Cl√≠nica Dental</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <a class="navbar-brand" href="#">üë®‚Äç‚öïÔ∏è Cl√≠nica Dental</a>
    <div class="navbar-nav ml-auto">
        <span class="navbar-text mr-3" id="userEmail"></span>
        <span class="navbar-text mr-3" id="userRole"></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
</nav>

<div class="container mt-4">
    <!-- Alertas -->
    <div id="alertContainer"></div>

    <h2>Dashboard - Sistema de Gesti√≥n</h2>

    <!-- Secci√≥n de Odont√≥logos -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>ü¶∑ Gesti√≥n de Odont√≥logos</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary mb-3" onclick="listarOdontologos()">
                üîÑ Actualizar Lista
            </button>
            <button class="btn btn-success mb-3" data-toggle="modal" data-target="#crearOdontologoModal">
                ‚ûï Crear Odont√≥logo
            </button>

            <div id="dentists-container" class="mt-3">
                <p class="text-muted">Haz clic en "Actualizar Lista" para ver los odont√≥logos</p>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Pacientes -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>üë• Gesti√≥n de Pacientes</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary mb-3" onclick="listarPacientes()">
                üîÑ Actualizar Lista
            </button>
            <button class="btn btn-success mb-3" data-toggle="modal" data-target="#crearPacienteModal">
                ‚ûï Crear Paciente
            </button>

            <div id="patients-container" class="mt-3">
                <p class="text-muted">Haz clic en "Actualizar Lista" para ver los pacientes</p>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Turnos -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>üìÖ Gesti√≥n de Turnos</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary mb-3" onclick="listarTurnos()">
                üîÑ Actualizar Lista
            </button>
            <button class="btn btn-success mb-3" onclick="mostrarAlerta('Funci√≥n de crear turno en desarrollo', 'info')">
                ‚ûï Crear Turno
            </button>

            <div id="appointments-container" class="mt-3">
                <p class="text-muted">Haz clic en "Actualizar Lista" para ver los turnos</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Odont√≥logo -->
<div class="modal fade" id="crearOdontologoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Odont√≥logo</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="crearOdontologoForm">
                    <div class="form-group">
                        <label for="dentistName">Nombre:</label>
                        <input type="text" class="form-control" id="dentistName" required>
                    </div>
                    <div class="form-group">
                        <label for="dentistLastName">Apellido:</label>
                        <input type="text" class="form-control" id="dentistLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="dentistLicense">Matr√≠cula:</label>
                        <input type="text" class="form-control" id="dentistLicense" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearOdontologo()">Crear</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Paciente -->
<div class="modal fade" id="crearPacienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Paciente</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="crearPacienteForm">
                    <div class="form-group">
                        <label for="patientName">Nombre:</label>
                        <input type="text" class="form-control" id="patientName" required>
                    </div>
                    <div class="form-group">
                        <label for="patientLastName">Apellido:</label>
                        <input type="text" class="form-control" id="patientLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="patientDni">DNI:</label>
                        <input type="text" class="form-control" id="patientDni" required>
                    </div>
                    <div class="form-group">
                        <label for="patientAddress">Direcci√≥n:</label>
                        <input type="text" class="form-control" id="patientAddress" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearPaciente()">Crear</button>
            </div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN
    const API_BASE_URL = 'https://dental-clinic-backend-53ys.onrender.com';

    // VERIFICAR AUTENTICACI√ìN AL CARGAR
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        const userEmail = localStorage.getItem('userEmail');

        if (!token) {
            mostrarAlerta('No est√°s autenticado. Redirigiendo al login...', 'warning');
            setTimeout(() => window.location.href = 'login.html', 2000);
            return;
        }

            // En el DOMContentLoaded, agreg√° esto:
    console.log('=== üîç DEBUG JWT ROLES ===');

    if (token) {
        try {
            // Decodificar el token manualmente
            const payload = JSON.parse(atob(token.split('.')[1]));
            console.log('üìã Token payload completo:', payload);
            console.log('üé≠ Roles en token:', payload.roles || payload.role || 'NO ROLES');
            console.log('üìß Subject:', payload.sub);

            // Mostrar esta info en la p√°gina tambi√©n
            document.getElementById('userRole').innerHTML =
                `<span class="badge badge-warning">DEBUG: ${payload.roles || payload.role || 'NO ROLE'}</span>`;

        } catch (error) {
            console.error('‚ùå Error decodificando token:', error);
        }
    }

        // Mostrar informaci√≥n del usuario
        document.getElementById('userEmail').textContent = userEmail || 'Usuario';

        // Verificar si es admin
        const esAdmin = userEmail === 'agusti@gmail.com';
        if (esAdmin) {
            document.getElementById('userRole').innerHTML = '<span class="badge badge-danger">ADMIN</span>';
        } else {
            document.getElementById('userRole').innerHTML = '<span class="badge badge-secondary">USER</span>';
        }

        console.log('‚úÖ Dashboard cargado - Usuario:', userEmail);

        // Cargar datos iniciales
        listarOdontologos();
        listarPacientes();
        listarTurnos();
    });

    // ü¶∑ FUNCIONES PARA ODONT√ìLOGOS
    async function listarOdontologos() {
        const token = localStorage.getItem('token');

        if (!token) {
            mostrarAlerta('No est√°s autenticado', 'danger');
            return;
        }

        const container = document.getElementById('dentists-container');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando odont√≥logos...</p></div>';

        try {
            const response = await fetch(`${API_BASE_URL}/dentists`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('üì° Response status odont√≥logos:', response.status);

            if (!response.ok) {
                throw new Error(`Error ${response.status}`);
            }

            const dentists = await response.json();
            console.log('‚úÖ Odont√≥logos recibidos:', dentists);
            mostrarOdontologos(dentists);

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error al cargar odont√≥logos:</strong><br>
                    ${error.message}
                    <br><br>
                    <button class="btn btn-sm btn-warning" onclick="listarOdontologos()">Reintentar</button>
                </div>
            `;
        }
    }

    function mostrarOdontologos(dentists) {
        const container = document.getElementById('dentists-container');

        if (!dentists || dentists.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    No hay odont√≥logos registrados.
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Matr√≠cula</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        dentists.forEach(dentist => {
            html += `
                <tr>
                    <td>${dentist.id || 'N/A'}</td>
                    <td>${dentist.name || 'N/A'}</td>
                    <td>${dentist.lastName || 'N/A'}</td>
                    <td><span class="badge badge-secondary">${dentist.license || 'N/A'}</span></td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
            <p class="text-muted">Total: ${dentists.length} odont√≥logo(s)</p>
        `;

        container.innerHTML = html;
    }

    async function crearOdontologo() {
        const token = localStorage.getItem('token');
        const name = document.getElementById('dentistName').value;
        const lastName = document.getElementById('dentistLastName').value;
        const license = document.getElementById('dentistLicense').value;

        if (!name || !lastName || !license) {
            mostrarAlerta('Complete todos los campos', 'warning');
            return;
        }

        console.log('ü¶∑ Creando odont√≥logo...');

        try {
            const response = await fetch(`${API_BASE_URL}/dentists`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    lastName: lastName,
                    license: license
                })
            });

            console.log('üì° Create response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const newDentist = await response.json();
            console.log('‚úÖ Odont√≥logo creado:', newDentist);

            // Cerrar modal y actualizar lista
            $('#crearOdontologoModal').modal('hide');
            document.getElementById('crearOdontologoForm').reset();

            mostrarAlerta('‚úÖ Odont√≥logo creado exitosamente', 'success');
            listarOdontologos();

        } catch (error) {
            console.error('Error:', error);
            mostrarAlerta('Error al crear odont√≥logo: ' + error.message, 'danger');
        }
    }

    // üë• FUNCIONES PARA PACIENTES
    async function listarPacientes() {
        const token = localStorage.getItem('token');

        if (!token) {
            mostrarAlerta('No est√°s autenticado', 'danger');
            return;
        }

        const container = document.getElementById('patients-container');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando pacientes...</p></div>';

        try {
            const response = await fetch(`${API_BASE_URL}/patients`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('üì° Response status pacientes:', response.status);

            if (!response.ok) {
                throw new Error(`Error ${response.status}`);
            }

            const patients = await response.json();
            console.log('‚úÖ Pacientes recibidos:', patients);
            mostrarPacientes(patients);

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error al cargar pacientes:</strong><br>
                    ${error.message}
                    <br><br>
                    <button class="btn btn-sm btn-warning" onclick="listarPacientes()">Reintentar</button>
                </div>
            `;
        }
    }

    function mostrarPacientes(patients) {
        const container = document.getElementById('patients-container');

        if (!patients || patients.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    No hay pacientes registrados.
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>DNI</th>
                            <th>Direcci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        patients.forEach(patient => {
            html += `
                <tr>
                    <td>${patient.id || 'N/A'}</td>
                    <td>${patient.name || 'N/A'}</td>
                    <td>${patient.lastName || 'N/A'}</td>
                    <td>${patient.dni || 'N/A'}</td>
                    <td>${patient.address || 'N/A'}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
            <p class="text-muted">Total: ${patients.length} paciente(s)</p>
        `;

        container.innerHTML = html;
    }

    async function crearPaciente() {
        const token = localStorage.getItem('token');
        const name = document.getElementById('patientName').value;
        const lastName = document.getElementById('patientLastName').value;
        const dni = document.getElementById('patientDni').value;
        const address = document.getElementById('patientAddress').value;

        if (!name || !lastName || !dni || !address) {
            mostrarAlerta('Complete todos los campos', 'warning');
            return;
        }

        console.log('üë• Creando paciente...');

        try {
            // ‚úÖ CORREGIR LOS CAMPOS SEG√öN EL DTO
            const patientData = {
                name: name,
                lastName: lastName,
                cardIdentity: dni,  // ‚ùå "dni" ‚Üí ‚úÖ "cardIdentity"
                admissionOfDate: new Date().toISOString().split('T')[0], // ‚úÖ Fecha actual
                address: {  // ‚úÖ Objeto address como pide el DTO
                    street: address,
                    number: "123",  // Agregar campo requerido
                    location: "Ciudad", // Agregar campo requerido
                    province: "Provincia" // Agregar campo requerido
                }
            };

            console.log('üì¶ Patient data being sent:', patientData);

            const response = await fetch(`${API_BASE_URL}/patients`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(patientData)
            });

            console.log('üì° Create response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.log('‚ùå Error response:', errorText);
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const newPatient = await response.json();
            console.log('‚úÖ Paciente creado:', newPatient);

            // Cerrar modal y actualizar lista
            $('#crearPacienteModal').modal('hide');
            document.getElementById('crearPacienteForm').reset();

            mostrarAlerta('‚úÖ Paciente creado exitosamente', 'success');
            listarPacientes();

        } catch (error) {
            console.error('Error:', error);
            mostrarAlerta('Error al crear paciente: ' + error.message, 'danger');
        }
    }

    // üìÖ FUNCIONES PARA TURNOS
    async function listarTurnos() {
        const token = localStorage.getItem('token');

        if (!token) {
            mostrarAlerta('No est√°s autenticado', 'danger');
            return;
        }

        const container = document.getElementById('appointments-container');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando turnos...</p></div>';

        try {
            const response = await fetch(`${API_BASE_URL}/appointments`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('üì° Response status turnos:', response.status);

            if (!response.ok) {
                throw new Error(`Error ${response.status}`);
            }

            const appointments = await response.json();
            console.log('‚úÖ Turnos recibidos:', appointments);
            mostrarTurnos(appointments);

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error al cargar turnos:</strong><br>
                    ${error.message}
                    <br><br>
                    <button class="btn btn-sm btn-warning" onclick="listarTurnos()">Reintentar</button>
                </div>
            `;
        }
    }

    function mostrarTurnos(appointments) {
        const container = document.getElementById('appointments-container');

        if (!appointments || appointments.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    No hay turnos registrados.
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Odont√≥logo</th>
                            <th>Paciente</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        appointments.forEach(appointment => {
            html += `
                <tr>
                    <td>${appointment.id || 'N/A'}</td>
                    <td>${appointment.date || 'N/A'}</td>
                    <td>${appointment.dentist ? appointment.dentist.name + ' ' + appointment.dentist.lastName : 'N/A'}</td>
                    <td>${appointment.patient ? appointment.patient.name + ' ' + appointment.patient.lastName : 'N/A'}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
            <p class="text-muted">Total: ${appointments.length} turno(s)</p>
        `;

        container.innerHTML = html;
    }

    // üîê FUNCI√ìN DE LOGOUT
    function logout() {
        if (confirm('¬øEst√° seguro de cerrar sesi√≥n?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
        }
    }

    // üõ†Ô∏è FUNCI√ìN DE ALERTAS
    function mostrarAlerta(mensaje, tipo = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${mensaje}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;

        const container = document.getElementById('alertContainer');
        container.appendChild(alertDiv);

        // Auto-eliminar despu√©s de 5 segundos
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
</body>
</html>