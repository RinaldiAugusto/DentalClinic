<!DOCTYPE html>
<html lang="es">
<head>
    <title>Login - Cl√≠nica Dental</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="login-container">
    <div class="text-center mb-4">
        <h2 class="text-primary">üë®‚Äç‚öïÔ∏è Cl√≠nica Dental</h2>
        <p class="text-muted">Sistema de Gesti√≥n</p>
        <div class="badge badge-success">üåê Conectado al Backend Real</div>
    </div>

    <!-- Formulario de Login -->
    <div id="loginSection">
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" class="form-control" id="email" placeholder="Ingrese su email" required>
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a:</label>
                <input type="password" class="form-control" id="password" placeholder="Ingrese su contrase√±a" required>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Iniciar Sesi√≥n</button>
        </form>
        <div class="text-center mt-3">
            <small class="text-muted">¬øNo tienes cuenta? <a href="#" onclick="mostrarRegistro()">Reg√≠strate aqu√≠</a></small>
        </div>
    </div>

    <!-- Agreg√° esto temporalmente despu√©s del formulario de login -->
    <div class="text-center mt-4">
        <div class="card">
            <div class="card-body">
                <h6>Credenciales de Prueba (despu√©s del reset)</h6>
                <small class="text-muted">
                    Email: <strong>admin@clinica.com</strong><br>
                    Password: <strong>admin123</strong>
                </small>
                <br>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="autofillCredentials()">
                    Auto-completar
                </button>
            </div>
        </div>
    </div>

    <script>
        function autofillCredentials() {
            document.getElementById('email').value = 'admin@clinica.com';
            document.getElementById('password').value = 'admin123';
            mostrarAlerta('Credenciales auto-completadas', 'info');
        }
    </script>

    <!-- Formulario de Registro (inicialmente oculto) -->
    <div id="registerSection" style="display: none;">
        <h5 class="text-center text-success">Crear Nueva Cuenta</h5>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerEmail">Email:</label>
                <input type="email" class="form-control" id="registerEmail" placeholder="Ingrese su email" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">Contrase√±a:</label>
                <input type="password" class="form-control" id="registerPassword" placeholder="Ingrese su contrase√±a (m√≠n. 6 caracteres)" required>
            </div>
            <div class="form-group">
                <label for="registerConfirmPassword">Confirmar Contrase√±a:</label>
                <input type="password" class="form-control" id="registerConfirmPassword" placeholder="Confirme su contrase√±a" required>
            </div>
            <button type="submit" class="btn btn-success btn-block" id="registerBtn">Registrarse</button>
        </form>
        <div class="text-center mt-2">
            <small class="text-muted">¬øYa tienes cuenta? <a href="#" onclick="mostrarLogin()">Inicia sesi√≥n aqu√≠</a></small>
        </div>
    </div>

    <div id="response"></div>
</div>

<script>
    // CONFIGURACI√ìN PARA BACKEND REAL
    const CONFIG = {
        API_BASE_URL: 'https://dental-clinic-backend-53ys.onrender.com',
        USE_MOCK: false
    };

    // FUNCIONES DE VISIBILIDAD
    function mostrarRegistro() {
        console.log('Mostrando formulario de registro');
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('registerSection').style.display = 'block';
    }

    function mostrarLogin() {
        console.log('Mostrando formulario de login');
        document.getElementById('registerSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
    }

    // FUNCI√ìN DE ALERT
    function mostrarAlerta(mensaje, tipo = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `${mensaje}<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>`;

        document.getElementById('response').innerHTML = '';
        document.getElementById('response').appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentElement) alertDiv.remove();
        }, 5000);
    }

    // MANEJADOR DE LOGIN CON DEBUGGING COMPLETO
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üîê INICIANDO LOGIN CON DEBUG...');

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const boton = document.getElementById('loginBtn');

        if (!email || !password) {
            mostrarAlerta('Complete todos los campos', 'danger');
            return;
        }

        boton.disabled = true;
        boton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Conectando...';

        try {
            console.log('üìß Email:', email);
            console.log('üîë Password:', '***' + password.substring(password.length - 2));
            console.log('üåê URL:', `${CONFIG.API_BASE_URL}/auth/login`);

            const credentials = { email, password };
            console.log('üì¶ Request body:', credentials);

            // Hacer el fetch con timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 seg timeout

            const response = await fetch(`${CONFIG.API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(credentials),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            console.log('üì° RESPONSE STATUS:', response.status);
            console.log('üì° RESPONSE OK:', response.ok);
            console.log('üì° RESPONSE HEADERS:', Object.fromEntries(response.headers.entries()));

            // Leer la respuesta como texto primero
            const responseText = await response.text();
            console.log('üì° RAW RESPONSE:', responseText);

            let data;
            try {
                data = JSON.parse(responseText);
                console.log('üì° PARSED DATA:', data);
            } catch (parseError) {
                console.error('‚ùå ERROR PARSING JSON:', parseError);
                console.log('üì° RESPONSE IS NOT JSON, raw:', responseText);
                throw new Error('El servidor devolvi√≥ una respuesta no v√°lida: ' + responseText.substring(0, 100));
            }

            if (response.ok) {
                console.log('‚úÖ LOGIN EXITOSO');
                console.log('üîê TOKEN RECIBIDO:', data.token ? data.token.substring(0, 50) + '...' : 'NO TOKEN');

                if (data.token) {
                    localStorage.setItem('token', data.token);
                    mostrarAlerta('‚úÖ ¬°Login exitoso! Redirigiendo...', 'success');

                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    throw new Error('No se recibi√≥ token del servidor');
                }
            } else {
                console.log('‚ùå LOGIN FALLIDO - Error data:', data);
                throw new Error(data.message || data.error || `Error HTTP ${response.status}`);
            }

        } catch (error) {
            console.error('üí• ERROR COMPLETO EN LOGIN:', error);

            let errorMessage = 'Error en el login';
            if (error.name === 'AbortError') {
                errorMessage = 'Timeout: El servidor no respondi√≥ en 10 segundos';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Error de conexi√≥n: No se pudo conectar al servidor';
            } else if (error.message.includes('CORS')) {
                errorMessage = 'Error CORS: El servidor bloque√≥ la petici√≥n';
            } else {
                errorMessage = error.message;
            }

            mostrarAlerta('‚ùå ' + errorMessage, 'danger');
        } finally {
            boton.disabled = false;
            boton.innerHTML = 'Iniciar Sesi√≥n';
        }
    });

    // MANEJADOR DE REGISTRO CON BACKEND REAL
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Procesando registro con backend real...');

        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('registerConfirmPassword').value;
        const boton = document.getElementById('registerBtn');

        // Validaciones
        if (!email || !password || !confirmPassword) {
            mostrarAlerta('Complete todos los campos', 'danger');
            return;
        }
        if (password !== confirmPassword) {
            mostrarAlerta('Las contrase√±as no coinciden', 'danger');
            return;
        }
        if (password.length < 6) {
            mostrarAlerta('La contrase√±a debe tener al menos 6 caracteres', 'danger');
            return;
        }

        boton.disabled = true;
        boton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Registrando...';

        try {
            console.log('Enviando registro a:', `${CONFIG.API_BASE_URL}/auth/register`);

            const response = await fetch(`${CONFIG.API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Error en el registro');
            }

            const result = await response.json();
            mostrarAlerta('‚úÖ ' + (result.message || 'Usuario registrado exitosamente'), 'success');

            // Limpiar y mostrar login
            setTimeout(() => {
                document.getElementById('registerForm').reset();
                mostrarLogin();
                // Auto-completar login
                document.getElementById('email').value = email;
                document.getElementById('password').value = password;
            }, 1000);

        } catch (error) {
            console.error('Error en registro:', error);
            mostrarAlerta('‚ùå Error: ' + error.message, 'danger');
        } finally {
            boton.disabled = false;
            boton.innerHTML = 'Registrarse';
        }
    });

    // VERIFICAR SI YA EST√Å AUTENTICADO (comentado temporalmente)
    // if (localStorage.getItem('token')) {
    //     window.location.href = 'dashboard.html';
    // }

    console.log('‚úÖ Login page cargada - Conectando a backend real');
    console.log('üåê API URL:', CONFIG.API_BASE_URL);

    // Debug adicional: probar conexi√≥n b√°sica
    fetch(`${CONFIG.API_BASE_URL}/public/health`)
        .then(response => response.text())
        .then(text => console.log('üè• Health check:', text))
        .catch(err => console.error('üí• Health check failed:', err));
</script>
</body>
</html>