<!DOCTYPE html>
<html lang="es">
<head>
    <title>Dashboard - Cl√≠nica Dental</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <a class="navbar-brand" href="#">üë®‚Äç‚öïÔ∏è Cl√≠nica Dental</a>
    <div class="navbar-nav ml-auto">
        <span class="navbar-text mr-3" id="userEmail"></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
</nav>

<div class="container mt-4">
    <h2>Dashboard - Sistema de Gesti√≥n</h2>

    <!-- Secci√≥n de Odont√≥logos -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>ü¶∑ Gesti√≥n de Odont√≥logos</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary mb-3" onclick="listarOdontologos()">
                üîÑ Actualizar Lista
            </button>
            <button class="btn btn-success mb-3" data-toggle="modal" data-target="#crearOdontologoModal">
                ‚ûï Crear Odont√≥logo
            </button>

            <div id="dentists-container" class="mt-3">
                <p class="text-muted">Haz clic en "Actualizar Lista" para ver los odont√≥logos</p>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n del Usuario -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>üë§ Informaci√≥n de Sesi√≥n</h5>
        </div>
        <div class="card-body">
            <div id="userInfo">
                <p><strong>Email:</strong> <span id="infoEmail"></span></p>
                <p><strong>Token:</strong> <span id="tokenPreview"></span></p>
                <p><strong>Estado:</strong> <span class="badge badge-success" id="connectionStatus">Conectado</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Odont√≥logo -->
<div class="modal fade" id="crearOdontologoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Odont√≥logo</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="crearOdontologoForm">
                    <div class="form-group">
                        <label for="dentistName">Nombre:</label>
                        <input type="text" class="form-control" id="dentistName" required>
                    </div>
                    <div class="form-group">
                        <label for="dentistLastName">Apellido:</label>
                        <input type="text" class="form-control" id="dentistLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="dentistLicense">Matr√≠cula:</label>
                        <input type="text" class="form-control" id="dentistLicense" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearOdontologo()">Crear</button>
            </div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN
    const API_BASE_URL = 'https://dental-clinic-backend-53ys.onrender.com';

    // VERIFICAR AUTENTICACI√ìN AL CARGAR
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        const userEmail = localStorage.getItem('userEmail');

        if (!token) {
            alert('No est√°s autenticado. Redirigiendo al login...');
            window.location.href = 'login.html';
            return;
        }

        // Mostrar informaci√≥n del usuario
        document.getElementById('userEmail').textContent = userEmail || 'Usuario';
        document.getElementById('infoEmail').textContent = userEmail || 'No disponible';
        document.getElementById('tokenPreview').textContent = token.substring(0, 30) + '...';

        console.log('‚úÖ Dashboard cargado - Usuario autenticado:', userEmail);
        console.log('üîê Token:', token.substring(0, 50) + '...');

        // Cargar datos iniciales
        listarOdontologos();
    });

    // ü¶∑ FUNCI√ìN CORREGIDA: LISTAR ODONT√ìLOGOS
    async function listarOdontologos() {
        const token = localStorage.getItem('token');

        console.log('üîç Iniciando listado de odont√≥logos...');
        console.log('üîê Token usado:', token ? token.substring(0, 30) + '...' : 'NO TOKEN');

        if (!token) {
            alert('No est√°s autenticado');
            window.location.href = 'login.html';
            return;
        }

        const container = document.getElementById('dentists-container');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando odont√≥logos...</p></div>';

        try {
            console.log('üåê Haciendo request a:', `${API_BASE_URL}/dentists`);

            const response = await fetch(`${API_BASE_URL}/dentists`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('üìä Response status:', response.status);
            console.log('üìä Response ok:', response.ok);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error response:', errorText);
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const dentists = await response.json();
            console.log('‚úÖ Odont√≥logos obtenidos:', dentists);

            // Mostrar los odont√≥logos
            mostrarOdontologos(dentists);

        } catch (error) {
            console.error('üí• Error completo:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error al cargar odont√≥logos:</strong><br>
                    ${error.message}
                    <br><br>
                    <button class="btn btn-sm btn-warning" onclick="listarOdontologos()">Reintentar</button>
                </div>
            `;
        }
    }

    // ü¶∑ FUNCI√ìN PARA MOSTRAR ODONT√ìLOGOS
    function mostrarOdontologos(dentists) {
        const container = document.getElementById('dentists-container');

        if (!dentists || dentists.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    No hay odont√≥logos registrados.
                    <button class="btn btn-sm btn-success ml-2" data-toggle="modal" data-target="#crearOdontologoModal">
                        Crear el primero
                    </button>
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Matr√≠cula</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        dentists.forEach(dentist => {
            html += `
                <tr>
                    <td>${dentist.name || 'N/A'}</td>
                    <td>${dentist.lastName || 'N/A'}</td>
                    <td><span class="badge badge-secondary">${dentist.license || 'N/A'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarOdontologo(${dentist.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarOdontologo(${dentist.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
            <p class="text-muted">Total: ${dentists.length} odont√≥logo(s)</p>
        `;

        container.innerHTML = html;
    }

    // ü¶∑ FUNCI√ìN PARA CREAR ODONT√ìLOGO
    async function crearOdontologo() {
        const token = localStorage.getItem('token');
        const name = document.getElementById('dentistName').value;
        const lastName = document.getElementById('dentistLastName').value;
        const license = document.getElementById('dentistLicense').value;

        if (!name || !lastName || !license) {
            alert('Complete todos los campos');
            return;
        }

        try {
            console.log('ü¶∑ Creando odont√≥logo...');

            const response = await fetch(`${API_BASE_URL}/dentists`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    lastName: lastName,
                    license: license
                })
            });

            console.log('üìä Create response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const newDentist = await response.json();
            console.log('‚úÖ Odont√≥logo creado:', newDentist);

            // Cerrar modal y actualizar lista
            $('#crearOdontologoModal').modal('hide');
            document.getElementById('crearOdontologoForm').reset();

            alert('‚úÖ Odont√≥logo creado exitosamente');
            listarOdontologos();

        } catch (error) {
            console.error('üí• Error creando odont√≥logo:', error);
            alert('Error al crear odont√≥logo: ' + error.message);
        }
    }

    // ü¶∑ FUNCIONES PARA EDITAR Y ELIMINAR (placeholder)
    function editarOdontologo(id) {
        alert('Editar odont√≥logo ID: ' + id + ' (funci√≥n en desarrollo)');
    }

    function eliminarOdontologo(id) {
        if (confirm('¬øEst√° seguro de eliminar este odont√≥logo?')) {
            alert('Eliminar odont√≥logo ID: ' + id + ' (funci√≥n en desarrollo)');
        }
    }

    // üîê FUNCI√ìN DE LOGOUT
    function logout() {
        if (confirm('¬øEst√° seguro de cerrar sesi√≥n?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
        }
    }

    // DEBUG: Probar conexi√≥n manualmente desde consola
    window.debugConnection = function() {
        const token = localStorage.getItem('token');
        console.log('üîê Token:', token);
        console.log('üåê API URL:', API_BASE_URL);

        fetch(`${API_BASE_URL}/auth/debug-user`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(r => r.json())
        .then(data => console.log('üîç Debug user:', data))
        .catch(err => console.error('üí• Debug error:', err));
    };
</script>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
</body>
</html>